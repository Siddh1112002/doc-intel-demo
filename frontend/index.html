<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Document Intelligence â€” Demo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#020617;
      --bg2:#020617;
      --card:#020617;
      --muted:#9aa4b2;
      --accent:#4f46e5;
      --accent-soft:#1d283a;
      --accent-2:#06b6d4;
      --glass: rgba(15,23,42,0.9);
      --radius:12px;
      --shadow: 0 14px 45px rgba(15,23,42,0.9);
      --text:#e5edff;
    }
    html,body{
      height:100%;
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
      background: radial-gradient(circle at top, #111827 0, #020617 55%, #000 100%);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
    }
    .wrap { max-width:1200px; margin:24px auto 32px; padding:0 14px; }

    header { display:flex; align-items:center; gap:14px; margin-bottom:12px; }
    .logo {
      width:44px;height:44px;border-radius:12px;
      display:grid;place-items:center;
      background:conic-gradient(from 210deg, #6366f1, #22d3ee, #a855f7, #6366f1);
      box-shadow:0 10px 30px rgba(79,70,229,0.35);
      font-weight:800;color:white;font-size:18px;
    }
    header h1 { margin:0; font-size:20px; letter-spacing:-0.2px }
    header p { margin:0; color:var(--muted); font-size:13px }

    .controls {
      display:flex; gap:12px; align-items:center;
      background:var(--glass);
      border-radius:16px;
      padding:12px;
      box-shadow:var(--shadow);
      border:1px solid rgba(148,163,184,0.18);
    }
    .file-wrapper {
      display:flex; align-items:center; gap:12px; flex:1;
      padding:10px 12px;
      background:rgba(15,23,42,0.9);
      border-radius:12px;
      cursor:pointer;
      border:1px solid rgba(148,163,184,0.2);
    }
    .file-pill {
      width:30px;height:30px;border-radius:999px;
      display:grid;place-items:center;
      background:rgba(79,70,229,0.12);
      color:#a5b4fc;font-size:14px;
    }
    .file-info { display:flex; flex-direction:column; gap:4px; }
    .file-name { font-weight:600; color:var(--text); font-size:14px; }
    .file-meta { font-size:12px; color:var(--muted); }

    input[type=file]{ position:absolute; left:-9999px; }

    .btn {
      padding:9px 16px;
      border-radius:999px;
      background:linear-gradient(90deg,#4f46e5,#8b5cf6);
      color:white;border:none;font-weight:600;
      cursor:pointer;
      box-shadow:0 12px 30px rgba(59,130,246,0.45);
      font-size:13px;
      white-space:nowrap;
    }
    .btn.secondary{
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.3);
      box-shadow:none;
      color:var(--muted);
      padding:7px 13px;
      font-weight:500;
    }
    .btn:disabled{
      opacity:0.6; cursor:not-allowed;
      box-shadow:none;
    }

    .layout { display:flex; gap:18px; margin-top:18px; align-items:flex-start; }
    .left { flex:1; display:flex; flex-direction:column; gap:14px; }
    .right { width:320px; display:flex; flex-direction:column; gap:14px; }

    .card{
      background:radial-gradient(circle at top, rgba(30,64,175,0.35) 0, rgba(15,23,42,0.98) 40%, rgba(15,23,42,0.98) 100%);
      border-radius:16px;
      padding:16px 16px 14px;
      box-shadow:var(--shadow);
      border:1px solid rgba(15,23,42,0.95);
    }
    .card h3 { margin:0 0 8px 0; font-size:15px; font-weight:600; letter-spacing:0.01em; }
    .summary{
      font-size:13px; color:var(--muted);
      line-height:1.4; max-height:120px; overflow:auto;
      background:rgba(15,23,42,0.8);
      border-radius:10px;
      padding:10px 12px;
      border:1px solid rgba(30,64,175,0.35);
    }

    .extracted-wrapper{
      background:rgba(15,23,42,0.88);
      border-radius:14px;
      border:1px solid rgba(30,64,175,0.35);
      padding:10px;
    }
    textarea#extractedText{
      width:100%; resize:vertical;
      min-height:340px;
      border-radius:10px;
      padding:12px 14px;
      font-family:ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size:13px; color:#e5e7eb;
      background:#020617;
      border:none;
      line-height:1.45;
      outline:none;
    }

    .hint { font-size:12px; color:var(--muted); margin-top:6px; }

    .key-field{
      display:flex; justify-content:space-between; align-items:flex-start;
      padding:8px 10px;
      background:rgba(15,23,42,0.96);
      border-radius:10px;
      margin-bottom:6px;
      font-size:12px;
      border:1px solid rgba(30,64,175,0.4);
    }
    .key-field-label{ color:var(--muted); }
    .key-field-value{ color:var(--text); font-weight:500; text-align:right; }

    .section-caption{
      font-size:11px; text-transform:uppercase;
      letter-spacing:0.12em;
      color:#64748b;
      margin-top:2px;
    }

    .table { width:100%; border-collapse:collapse; margin-top:8px; font-size:12px; }
    .table thead th{
      text-align:left; color:#94a3b8;
      padding:8px 10px;
      border-bottom:1px solid rgba(51,65,85,0.9);
      font-weight:500;
      background:radial-gradient(circle at top left, rgba(30,64,175,0.3), transparent);
    }
    .table tbody td{
      padding:8px 10px;
      border-bottom:1px dashed rgba(30,64,175,0.35);
      color:#e5e7eb;
      vertical-align:top;
    }
    .table tbody tr:hover{
      background:radial-gradient(circle at left, rgba(30,64,175,0.35), rgba(15,23,42,0.95));
      cursor:pointer;
    }

    .footer{
      margin-top:18px;
      text-align:center;
      font-size:11px;
      color:#64748b;
    }

    @media(max-width:980px){
      .layout{flex-direction:column;}
      .right{width:auto;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">DI</div>
      <div>
        <h1>Document Intelligence</h1>
        <p>Upload a PDF or image to extract text, key invoice fields, and see amount/date context instantly.</p>
      </div>
    </header>

    <div class="controls">
      <label class="file-wrapper">
        <span class="file-pill">ðŸ“„</span>
        <div class="file-info">
          <div class="file-name" id="fileName">No file selected</div>
          <div class="file-meta" id="fileMeta">Click to choose a PDF or image from your system</div>
        </div>
        <input id="fileInput" type="file" accept=".pdf,image/*" />
      </label>

      <button id="btnUpload" class="btn">Upload & Analyze</button>
    </div>

    <div class="layout">
      <div class="left">
        <div class="card">
          <h3>Summary</h3>
          <div id="summary" class="summary">No file uploaded yet.</div>
        </div>

        <div class="card">
          <h3>Extracted Text</h3>
          <div class="extracted-wrapper">
            <textarea id="extractedText" placeholder="Extracted text will appear here..." readonly></textarea>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px;">
            <div class="hint">Tip: click any amount/date in the tables to highlight that line in the extracted text.</div>
            <button id="btnCopy" class="btn secondary">Copy text</button>
          </div>
        </div>

        <div class="card">
          <h3>Amounts â†’ Context (what each amount refers to)</h3>
          <div class="section-caption">Once analyzed, every detected amount is mapped back to the line where it appears.</div>
          <div id="amountsSection" style="max-height:260px; overflow:auto; margin-top:6px;">
            <div class="hint">Upload a document to see detected amounts with their surrounding lines.</div>
          </div>
        </div>

        <div class="card">
          <h3>Dates â†’ Context (what each date refers to)</h3>
          <div class="section-caption">Detected dates (invoice date, due date, etc) will appear with their surrounding line.</div>
          <div id="datesSection" style="max-height:210px; overflow:auto; margin-top:6px;">
            <div class="hint">Dates will show here after analysis.</div>
          </div>
        </div>

        <div class="footer">
          Built with Python Â· Tesseract / PyMuPDF Â· FastAPI Â· Render + Vercel â€” interview-ready demo
        </div>
      </div>

      <div class="right">
        <div class="card">
          <h3>Key Fields</h3>
          <div class="key-field">
            <div class="key-field-label">Vendor</div>
            <div class="key-field-value" id="f_vendor">â€”</div>
          </div>
          <div class="key-field">
            <div class="key-field-label">Invoice #</div>
            <div class="key-field-value" id="f_invoice">â€”</div>
          </div>
          <div class="key-field">
            <div class="key-field-label">Dates</div>
            <div class="key-field-value" id="f_dates">â€”</div>
          </div>
          <div class="key-field">
            <div class="key-field-label">Amounts</div>
            <div class="key-field-value" id="f_amounts">â€”</div>
          </div>

          <div style="margin-top:10px;">
            <button id="btnExportJson" class="btn secondary" style="width:100%;" disabled>Export JSON</button>
            <button id="btnCopyAmounts" class="btn secondary" style="width:100%;margin-top:6px;" disabled>Copy amounts</button>
          </div>
        </div>

        <div class="card">
          <h3>Status</h3>
          <div id="uploadStatus" class="hint">Ready</div>
        </div>
      </div>
    </div>
  </div>

<script>
"use strict";

// === Backend base URL: Render in production (Vercel), same-origin locally ===
const API_BASE = window.location.hostname.includes("vercel.app")
  ? "https://doc-intel-8zy6.onrender.com"
  : "";

// --- DOM references ---
const fileInput       = document.getElementById("fileInput");
const fileNameEl      = document.getElementById("fileName");
const fileMetaEl      = document.getElementById("fileMeta");
const btnUpload       = document.getElementById("btnUpload");
const extractedTextEl = document.getElementById("extractedText");
const summaryEl       = document.getElementById("summary");
const amountsSection  = document.getElementById("amountsSection");
const datesSection    = document.getElementById("datesSection");
const f_vendor        = document.getElementById("f_vendor");
const f_invoice       = document.getElementById("f_invoice");
const f_dates         = document.getElementById("f_dates");
const f_amounts       = document.getElementById("f_amounts");
const btnExportJson   = document.getElementById("btnExportJson");
const btnCopy         = document.getElementById("btnCopy");
const btnCopyAmounts  = document.getElementById("btnCopyAmounts");
const uploadStatus    = document.getElementById("uploadStatus");

let lastFilename = null;

// --- File label behaviour (no programmatic click -> no double dialog) ---
fileInput.addEventListener("change", () => {
  const f = fileInput.files[0];
  if (!f) {
    fileNameEl.textContent = "No file selected";
    fileMetaEl.textContent = "Click to choose a PDF or image from your system";
    return;
  }
  fileNameEl.textContent = f.name;
  fileMetaEl.textContent = `${Math.round(f.size / 1024)} KB â€¢ ${f.type || "file"}`;
});

// --- Upload & analyze ---
btnUpload.addEventListener("click", async () => {
  const f = fileInput.files[0];
  if (!f) { alert("Please choose a file first."); return; }
  if (f.size === 0) { alert("Selected file is empty."); return; }

  btnUpload.disabled = true;
  btnUpload.textContent = "Uploading...";
  uploadStatus.textContent = "Uploading...";
  summaryEl.textContent = "Processing...";

  const fd = new FormData();
  fd.append("file", f);

  try {
    const res = await fetch(`${API_BASE}/upload`, { method: "POST", body: fd });
    if (!res.ok) {
      const txt = await res.text();
      summaryEl.textContent = `Server error: ${res.status} ${txt}`;
      uploadStatus.textContent = "Error";
      return;
    }

    const j = await res.json();
    lastFilename = j.filename || f.name;

    const text = j.clean_text || j.text || "";
    extractedTextEl.value = text || "";

    if (j.error) {
      summaryEl.textContent = j.summary || "Partial result â€” see JSON for details.";
      uploadStatus.textContent = "Partial result";
    } else {
      summaryEl.textContent = j.summary || "Extraction complete.";
      uploadStatus.textContent = "Processing complete";
    }

    const fields = j.fields || {};
    f_vendor.textContent  = fields.vendor || fields.client || "â€”";
    f_invoice.textContent = fields.invoice || fields.invoice_no || "â€”";

    let amounts = Array.isArray(fields.amounts) ? fields.amounts.map(String)
                 : fields.amounts ? [String(fields.amounts)] : [];
    let dates   = Array.isArray(fields.dates) ? fields.dates.map(String)
                 : fields.dates ? [String(fields.dates)] : [];

    // Fallback regex if backend didn't return amounts/dates
    if (!amounts.length) {
      const amtRx = /(?:USD\s*)?(?:\$)?\d{1,3}(?:[,\d]*)(?:\.\d{1,2})?/g;
      const found = new Set(); let m;
      while ((m = amtRx.exec(text)) !== null) found.add(m[0]);
      amounts = Array.from(found);
    }
    if (!dates.length) {
      const r1 = /\b\d{4}-\d{2}-\d{2}\b/g;
      const r2 = /\b\d{1,2}\/\d{1,2}\/\d{2,4}\b/g;
      const r3 = /\b(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\.?\s+\d{1,2},\s*\d{4}\b/ig;
      const found = new Set(); let mm;
      [r1,r2,r3].forEach(rx => { while ((mm = rx.exec(text)) !== null) found.add(mm[0]); });
      dates = Array.from(found);
    }

    amounts = Array.from(new Set(amounts)).slice(0, 60);
    dates   = Array.from(new Set(dates)).slice(0, 60);

    f_amounts.textContent = amounts.length ? amounts.join(" â€¢ ") : "â€”";
    f_dates.textContent   = dates.length   ? dates.join(" â€¢ ")   : "â€”";

    renderAmountsTable(amounts, text);
    renderDatesTable(dates, text);

    btnExportJson.disabled  = false;
    btnCopyAmounts.disabled = false;

  } catch (err) {
    console.error(err);
    summaryEl.textContent = "Request failed: " + (err.message || err);
    uploadStatus.textContent = "Failed";
  } finally {
    btnUpload.disabled = false;
    btnUpload.textContent = "Upload & Analyze";
  }
});

// --- Context helpers ---
function findLineContext(text, token){
  if (!text) return "";
  const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);

  for (const ln of lines) if (ln.includes(token)) return ln;

  const digits = token.replace(/[^\d.]/g, "");
  if (digits) {
    for (const ln of lines) if (ln.includes(digits)) return ln;
  }

  for (const ln of lines) if (ln.toLowerCase().includes(token.toLowerCase())) return ln;

  return "";
}

function highlightText(line){
  if (!line) return;
  const text = extractedTextEl.value;
  let idx = text.indexOf(line);
  if (idx === -1) {
    const digits = line.replace(/[^\d]/g, "");
    if (!digits) return;
    idx = text.indexOf(digits);
    if (idx === -1) return;
    extractedTextEl.focus();
    extractedTextEl.setSelectionRange(idx, idx + digits.length);
    return;
  }
  extractedTextEl.focus();
  extractedTextEl.setSelectionRange(idx, idx + line.length);
}

// --- Render tables ---
function renderAmountsTable(amounts, text){
  amountsSection.innerHTML = "";
  if (!amounts.length){
    amountsSection.innerHTML = '<div class="hint">No amounts detected.</div>';
    return;
  }
  const tbl = document.createElement("table");
  tbl.className = "table";
  const thead = document.createElement("thead");
  thead.innerHTML = "<tr><th>Amount</th><th>Context / line</th></tr>";
  const tbody = document.createElement("tbody");
  tbl.appendChild(thead); tbl.appendChild(tbody);

  for (const a of amounts){
    const tr = document.createElement("tr");
    const tdA = document.createElement("td");
    tdA.textContent = a;
    const ctx = findLineContext(text, a) || "â€”";
    const tdC = document.createElement("td");
    tdC.textContent = ctx;
    tr.appendChild(tdA); tr.appendChild(tdC);
    tr.addEventListener("click", () => highlightText(ctx || a));
    tbody.appendChild(tr);
  }
  amountsSection.appendChild(tbl);
}

function renderDatesTable(dates, text){
  datesSection.innerHTML = "";
  if (!dates.length){
    datesSection.innerHTML = '<div class="hint">No dates detected.</div>';
    return;
  }
  const tbl = document.createElement("table");
  tbl.className = "table";
  const thead = document.createElement("thead");
  thead.innerHTML = "<tr><th>Date</th><th>Context / line</th></tr>";
  const tbody = document.createElement("tbody");
  tbl.appendChild(thead); tbl.appendChild(tbody);

  for (const d of dates){
    const tr = document.createElement("tr");
    const tdD = document.createElement("td");
    tdD.textContent = d;
    const ctx = findLineContext(text, d) || "â€”";
    const tdC = document.createElement("td");
    tdC.textContent = ctx;
    tr.appendChild(tdD); tr.appendChild(tdC);
    tr.addEventListener("click", () => highlightText(ctx || d));
    tbody.appendChild(tr);
  }
  datesSection.appendChild(tbl);
}

// --- Copy buttons ---
btnCopy.addEventListener("click", async () => {
  try{
    await navigator.clipboard.writeText(extractedTextEl.value || "");
    btnCopy.textContent = "Copied";
    setTimeout(() => btnCopy.textContent = "Copy text", 1200);
  }catch(e){ alert("Copy failed: " + e); }
});

btnCopyAmounts.addEventListener("click", async () => {
  try{
    await navigator.clipboard.writeText(f_amounts.textContent || "");
    btnCopyAmounts.textContent = "Copied";
    setTimeout(() => btnCopyAmounts.textContent = "Copy amounts", 1200);
  }catch(e){ alert("Copy failed: " + e); }
});

// --- Export JSON via Render backend ---
btnExportJson.addEventListener("click", async () => {
  if (!lastFilename){ alert("Upload a file first."); return; }
  try{
    const url = `${API_BASE}/export_json?filename=${encodeURIComponent(lastFilename)}`;
    const res = await fetch(url);
    if (!res.ok){
      const txt = await res.text();
      alert("Export JSON failed: " + txt);
      return;
    }
    const blob = await res.blob();
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = lastFilename + ".json";
    a.click();
    URL.revokeObjectURL(a.href);
  }catch(e){
    alert("Export JSON failed: " + e);
  }
});

// initial states
btnExportJson.disabled = true;
btnCopyAmounts.disabled = true;
</script>
</body>
</html>
